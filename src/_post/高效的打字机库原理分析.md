---
layout: post
title: typical ç²¾ç®€æ‰“å­—æœºçš„åŸç†
author: beet
post: '@19@'
date: 2020-10-14 10:09:25
nailimg: https://static.beetcb.com?path=/nailimg/js.png
tags: js
---

<script>
async function type(t,...e){for(const n of e)switch(typeof n){case"string":await edit(t,n);break;case"number":await wait(n);break;case"function":await n(t,...e);break;default:await n}}async function edit(t,e){const n=getOverlap(t.textContent,e);await perform(t,[...deleter(t.textContent,n),...writer(e,n)])}async function wait(t){await new Promise(e=>setTimeout(e,t))}async function perform(t,e,n=60){for(const i of editor(e))i(t),await wait(n+n*(Math.random()-.5))}function*editor(t){for(const e of t)yield t=>requestAnimationFrame(()=>t.textContent=e)}function*writer([...t],e=0,n=t.length){for(;e<n;)yield t.slice(0,++e).join("")}function*deleter([...t],e=0,n=t.length){for(;n>e;)yield t.slice(0,--n).join("")}function getOverlap(t,[...e]){return[...t,NaN].findIndex((t,n)=>e[n]!==t)}
</script>
<blockquote>
<p style="height:27px" id="sample"></p>
</blockquote>
<script>
const steps = [1000, 'hi ğŸ‘‹', 1000, 'there ğŸ¤', 1000, 'typical ğŸ‰'];type(sample, ...steps, type);
</script>

### æ‰“å­—æœºçš„åŠŸèƒ½

Demo å¦‚ä¸Šï¼Œé¡µé¢ä¸­çš„æ‰“å­—æœºå¯æä¾›äº¤äº’æ€§çš„æ–‡æœ¬ç±»å†…å®¹å±•ç¤ºã€å¢åŠ é¡µé¢è¶£å‘³æ€§ï¼Œå…¶åŠŸèƒ½ä¸»è¦æœ‰ï¼š(ä»¥åŠ¨ç”»å½¢å¼) æ‰“å­—ã€åˆ å­—ã€æš‚åœã€å¾ªç¯ï¼Œç¡®å®å¾ˆé…·ï¼

### typical çš„ä¼˜ç‚¹

æ‰“å­—åŠŸèƒ½å¹¶éå¿…è¦åŠŸèƒ½ï¼Œæ— éœ€å¼•å…¥ `typed` é‚£æ ·çš„å¤§åº“ã€‚è¿™æ—¶ï¼Œ`typical` ä»¥å…¶ä¼˜é›…è½»å·§çš„æ­¥ä¼åƒæˆ‘ä»¬èµ°æ¥ï¼Œå…¶æºç ï¼Œä»…ä»… 50 ä½™è¡Œï¼Œå´äº”è„ä¿±å…¨ã€‚å¯¹ Promise å’Œ Generator çš„è¿ç”¨ï¼Œæ°åˆ°å¥½å¤„ï¼Œååˆ†å€¼å¾—æ¨¡ä»¿å­¦ä¹ ã€‚æ­¤å¤–ï¼Œ`typical` æœ‰ä¸ªå½©è›‹ï¼šåˆ©ç”¨è½»å¾®çš„åœé¡¿ï¼Œæ¨¡ä»¿äººæ‰“å­—çš„å»¶è¿Ÿã€‚

> beet å†™ä¸‹æ­¤æ–‡å­¦å­¦å®ƒçš„æ€è·¯ï¼Œåˆ†æä¸€ä¸‹åŸç†ï¼Œè®°å½•åˆ†æçš„æ€è·¯ã€‚

### åŸç†ï¼šä»åŠŸèƒ½åˆ‡å…¥

> é¡¹ç›®ä»£ç æ²¡æœ‰æ³¨é‡Šï¼Œæ‰€ä»¥æˆ‘è®¤ä¸ºåº”è¯¥äº†è§£ `typical` çš„åŠŸèƒ½åï¼Œå†å»æ·±å…¥å…¶åŸç†ï¼Œèƒ½æ›´å¥½ç†è§£é¡¹ç›®ä½œè€…çš„æ„å›¾ï¼Œä¸‹é¢æ˜¯ typical å‡ å¤§åŠŸèƒ½ï¼Œæˆ‘ä¼šåˆ†åˆ«åˆ†æå…¶åŸç†ï¼š

#### åŸºæœ¬æ‰“å­—åŠŸèƒ½

ç”¨æ³•ï¼š`type(htmlElement, 'text_you_wanna_type')`

é¦–å…ˆï¼Œ`type()` çš„åŸå‹ï¼š

```js
/* Snippets 1 */
async function type(node, ...args) {
  // (*)
  for (const arg of args) {
    switch (typeof arg) {
      case 'string': // (**)
        await edit(node, arg)
        break
      case 'number':
        await wait(arg)
        break
      case 'function':
        await arg(node, ...args)
        break
      default:
        await arg
    }
  }
}
```

`(*)` å¤„ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼Œargs å˜é‡ç°åœ¨å±äºä¸€ä¸ªå¯éå†çš„æ•°æ®ç»“æ„ï¼Œæ¯æ¬¡éå†å¯ä»¥å¾—åˆ°ä¼ å…¥ type() å‡½æ•°çš„ä¸‹ä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥åœ¨æ­¤ç§æƒ…å†µä¸‹ï¼Œfor å¾ªç¯ä½“å†…æ˜¯å¯¹å„ç§æƒ…å†µçš„å¤„ç†ï¼š

- `string`: edit(node, arg)
- `number`: wait(arg)
- `function`: arg(node, ...args)
- default: ä¸»è¦åŒ…å«å¯¹ Promise çš„å¤„ç†

`(**)` å¤„å±äºå½“å‰æƒ…å½¢ï¼Œè‡ªç„¶è·³è½¬åˆ° edit() å‡½æ•°ï¼š

```js
/* Snippets 2 */
async function edit(node, text) {
  const overlap = getOverlap(node.textContent, text) // (*)
  await perform(node, [
    ...deleter(node.textContent, overlap), // (**)
    ...writer(text, overlap), // (***)
  ])
}
```

å‡½æ•°åªæ˜¯ä¸ªé»‘åŒ£å­ï¼Œå½“æˆ‘ä»¬æš‚æ—¶ä¸äº†è§£å…¶ä½œç”¨æ—¶ï¼Œæœ›æ–‡ç”Ÿä¹‰ä¹Ÿä¸å¸¸æ˜¯ä¸€ç§æœºæ™ºä¹‹ä¸¾ï¼Œ(\*\*) å’Œ (\*\*\*) å¤„ deleter å’Œ writer æå¯èƒ½æ˜¯æ‰“å­—æ—¶åˆ ã€æ·»åŠŸèƒ½çš„å®ç°ï¼Œå†è€…ï¼Œä»–ä»¬éƒ½ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼Œä¸€å®šæ˜¯å¯éå†çš„æ•°ç»„æˆ–å…¶ä»–æ•°æ®ç»“æ„ã€‚(\*) å¤„ overnap å­—é¢æ˜¯é‡å ï¼Œä¾æ®æ–‡æ¡£çš„ `Smart delete` åŠŸèƒ½ï¼Œå®ƒå¯èƒ½æ˜¯è®¡ç®—ç›®æ ‡å­—ç¬¦æ®µä¸å½“å‰å­—ç¬¦çš„é‡å¤å­—æ®µã€‚æœ€åï¼Œæ ¹æ®å‡ ä¸ªå‡½æ•°ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œè‚¯å®šè¦å…ˆè¯»æ‡‚ overlapï¼Œå† deleter \ writerï¼Œæœ€å perform å‡½æ•°ï¼š

```js
/* Snippets 3 */
function getOverlap(start, [...end]) {
  return [...start, NaN].findIndex((char, i) => end[i] !== char)
}
```

é€šè¿‡å¯¹å®å‚å’Œå½¢å‚çš„åˆ†æï¼ŒSnippets 2 ä¸­çš„ overlap è¡¨ç¤ºï¼šæ‹¿ç›®æ ‡å…ƒç´ åŸæœ¬çš„å­—ç¬¦ä¸ç›®æ ‡å­—ç¬¦ä¸²æ³¨æ„æ¯”è¾ƒï¼Œæ‰¾å‡ºä¸åŒçš„é‚£ä¸€ä¸ªç´¢å¼•ï¼Œèµ‹å€¼ç»™ overlap å˜é‡ã€‚æ­¤æ—¶åº”è¯¥å¯¹ deleter \ writer çš„åŠŸèƒ½æ›´åŠ æ˜ç¡®äº†ï¼Œé©¬ä¸Šæ¥çœ‹çœ‹å®ƒä»¬çš„å…·ä½“å®ç°ï¼š

```js
/* Snippets 4 */
function* writer([...text], startIndex = 0, endIndex = text.length) {
  while (startIndex < endIndex) {
    yield text.slice(0, ++startIndex).join('')
  }
}

function* deleter([...text], startIndex = 0, endIndex = text.length) {
  while (endIndex > startIndex) {
    yield text.slice(0, --endIndex).join('')
  }
}
```

æœç„¶ï¼Œä»–ä»¬éƒ½æ˜¯å¯¹å­—ç¬¦ä¸²çš„å‡ã€å¢å¤„ç†ï¼Œé€šè¿‡ Generator å‡½æ•°ç”Ÿæˆå¯éå†çš„æ•°æ®ç»“æ„ã€‚å…·ä½“æ¥è¯´ï¼šdeleter è´Ÿè´£ç”Ÿæˆ(ç›¸å¯¹ä¸ä¸‹æ¬¡ç›®æ ‡å­—ç¬¦ä¸²)éœ€è¦åˆ é™¤çš„å†…å®¹ï¼Œä¿ç•™å¯ä»¥å›æ”¶çš„å†…å®¹ï¼Œwriter è´Ÿè´£ç”Ÿæˆ(ç›¸å¯¹ä¸ä¸‹æ¬¡ç›®æ ‡å­—ç¬¦ä¸²)è¿˜æ²¡æœ‰æ‰“å°çš„åºåˆ—ï¼Œæ¯”å¦‚åŸæœ¬å…ƒç´ æ–‡æœ¬å†…å®¹æ˜¯ 'bee'ï¼Œæ‰§è¡Œ `type(htmlElement, 'beetcb')` ï¼Œdeleter ä¼šå¾—åˆ°ç±»ä¼¼ () çš„ç©ºåºåˆ—ï¼Œè€Œ wirter ä¼šå¾—åˆ°ç±»ä¼¼ ('beet', 'beetc', 'beetcb') çš„åºåˆ—ï¼Œæ­¤æ—¶é€šè¿‡å±•å¼€è¿ç®—ç¬¦å¯ä»¥å¾—åˆ°æ–°çš„æ•°ç»„ï¼š\['beet', 'beetc', 'beetcb'\]ã€‚ ä½œä¸ºå®å‚ä¼ é€’ç»™ perform() å‡½æ•°, ç°åœ¨æˆ‘ä»¬å»ç§ç§ perform å‡½æ•°ï¼š

```js
/* Snippets 5 */
async function perform(node, edits, speed = 60) {
  for (const op of editor(edits)) {
    // change the text
    op(node)
    // pause a while
    await wait(speed + speed * (Math.random() - 0.5))
  }
}

function* editor(edits) {
  for (const edit of edits) {
    yield node => requestAnimationFrame(() => (node.textContent = edit))
  }
}
```

editor å‡½æ•°ç±»ä¼¼ deleter \ writerï¼Œç”Ÿæˆ(æ”¹å˜å­—ç¬¦)éœ€è¦è¯·æ±‚çš„åŠ¨ç”»å¸§åºåˆ—ï¼Œæ¯”å¦‚å»¶ç»­ä¸Šé¢çš„ä¾‹å­ï¼Œç”Ÿæˆ:

```js
(
(node) => requestAnimationFrame(() => (node.textContent = 'beet'),
(node) => requestAnimationFrame(() => (node.textContent = 'beetc'),
(node) => requestAnimationFrame(() => (node.textContent = 'beetcb')
)
```

æ‰€ä»¥ perform é‡Œçš„ op æ˜¯æ¯æ¬¡è¿­ä»£æ—¶ç”¨äºæ”¹å˜æ–‡å­—çš„ç®­å¤´å‡½æ•°, æ‰§è¡Œå®ƒå°±ç›¸å½“äºæ”¹å˜æ–‡å­—, ç„¶åå€Ÿç”¨ä¸€ä¸ª setTimeOut å resolve çš„ promise æ¥æš‚åœä¸€ä¼šå„¿(wait å‡½æ•°ï¼Œæ¯”è¾ƒç®€å•ï¼Œä¸èµ˜è¿°)ï¼Œåç»§ç»­æ”¹å˜æ–‡å­—ã€‚

å†æ¬¡è€ƒè™‘ä¹‹å‰ä¸¾çš„ä¾‹å­ï¼Œæ­¤æ—¶ä» `'bee' -> 'beetcb'` çš„è¿‡ç¨‹å·²ç»å®Œæˆï¼Œè¿™ä¹Ÿç»“æŸäº† `type(htmlElement, 'beetcb')` çš„æ‰§è¡Œè¿‡ç¨‹ã€‚

#### æš‚åœ

ç”¨æ³•ï¼š`type(ele, 'beetcb', 1000, 'bee')`

æ¯”è¾ƒä¸Šé¢çš„ä¾‹å­ï¼Œå¤šäº†ä¸¤æ¬¡è¿­ä»£ï¼Œå†çœ‹ Snippets 1 çš„è½¬æ¢è¯­å¥ï¼Œæ˜“çŸ¥ç¬¬ä¸‰æ¬¡è¿­ä»£è°ƒç”¨ wait å‡½æ•°æš‚åœ 1000ms åè¿­ä»£åˆ° 'bee' çš„æ—¶å€™ï¼Œå†æ¬¡æ‰§è¡Œå¤„ç†å­—ç¬¦ä¸²çš„æ‰€æœ‰æ“ä½œï¼Œæ­¤æ—¶å¢å‡åˆ™å’Œç¬¬ä¸€æ¬¡ä¾‹å­æˆªç„¶ç›¸å deleter è¿”å› ('beetc', 'beet', 'bee') åºåˆ—ï¼Œè€Œ writer è¿”å› () åºåˆ—ï¼Œè¿™å°±å®Œæˆäº† `'bee' -> 'beetcb' -> 'bee'` éœ€è¦çš„æ‰€æœ‰æ“ä½œã€‚

#### å¾ªç¯

ç”¨æ³•ï¼š`type(ele, 1000, 'beetcb', 1000, 'bee', type)`

ç”±è½¬æ¢è¯­å¥å¯çŸ¥ï¼Œå½“è¿­ä»£åˆ°å‡½æ•°æ—¶ï¼Œæ‰§è¡Œæ­¤å‡½æ•°ï¼Œè€Œä¸”å…¶å‚æ•°ä¸åŸæœ¬çš„ type å‡½æ•°ç›¸åŒï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºé€’å½’ï¼Œè¿™å°±å®Œæˆäº†å¾ªç¯çš„è¿‡ç¨‹ã€‚

> hint: è‡³äºä¸ºä½•è¦åœ¨ 'beetcb' å‰é˜²æ­¢ä¸€ä¸ª 1000ï¼Œæ˜¯ä¿è¯å‡ºç¬¬ä¸€æ¬¡ä»¥å¤–çš„æ‰€æœ‰é€’å½’ç•™æœ‰ 1000ms çš„æš‚åœæ—¶é—´

#### å‡½æ•°

ç”¨æ³•ï¼š`type(ele, () => console.log('cloud used for anything'))`

è¿™å…¶å®æ˜¯ä¸ºäº†å®Œæˆé€’å½’çš„å‰¯äº§å“ï¼Œå› ä¸ºå½“è¿­ä»£åˆ°å‡½æ•°æ—¶ï¼Œé»˜è®¤æ‰§è¡Œå®ƒï¼Œæ­¤æ—¶ä¸ä¼ å‚ä¹Ÿæ²¡å½±å“ï¼Œåœ¨è¿­ä»£ type çš„å‚æ•°æ—¶è¿­ä»£åˆ°äº†è¿™ä¸ªå‡½æ•°ï¼Œå‡½æ•°è‡ªç„¶å°±æ‰§è¡Œäº†ã€‚

#### Promise

ç”¨æ³•: `type(ele, new Promise(...))`

å¯ä»¥çœ‹åˆ°ï¼Œè½¬æ¢è¯­å¥æœ€åä¸€å¥ï¼Œawait ä¼ å…¥çš„ Promiseï¼Œç­‰å®ƒ resolve ä¹‹åï¼Œå†å»ç»§ç»­è¿­ä»£ã€‚

### ä¼˜ç‚¹åˆ†æ

- æŠŠå‡½æ•°å‚æ•°äº¤ç»™ `switch case` è¯­å¥å¤„ç†ï¼Œæ—¢çªç ´äº†å½¢å‚å®å‚é¡ºåºå¿…é¡»ä¸€è‡´çš„é™åˆ¶ï¼Œåˆå·§å¦™åœ°å¤ç”¨äº†å¤§éƒ¨åˆ†ä»£ç 
- Generator ç¡®å®ç²¾ç®€ï¼Œè€Œæˆ‘è¿˜åœ¨ç”¨ Array.reduce()ï¼Œèœ
- å¤§é‡ç”¨åˆ°å‰©ä½™ã€å±•å¼€è¿ç®—ç¬¦ï¼Œä¼˜é›…çš„å†™æ³•
- å¼‚æ­¥ä¸­å«åŒæ­¥ï¼Œè¿™ä¹Ÿæ˜¯ `async await` çš„ç®€æ´ä¹‹å¤„
  ...

> æœ€åï¼šæ”¾ä¸ª [repo åœ°å€](https://github.com/camwiegert/typical) å» star å§ï¼
