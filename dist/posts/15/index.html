<!DOCTYPE html><html><head>
	    <meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>BrowserStack-JS引擎机理(浅解) | Beet's blog, a frontEnd lover's blog site</title>
    <link type="text/css" rel="stylesheet" href="/static/main.css">
		<meta name="description" content=" Beet's blog, share &amp; blogging">
		<meta name="title" content="BrowserStack-JS引擎机理(浅解) | Beet's blog, a frontEnd lover's blog site">
		<meta property="og:site_name" content="beet's blog">
		<meta property="og:url" content="https://www.beetcb.com/">
		<meta property="og:type" content="website">
		<meta property="og:title" content="BrowserStack-JS引擎机理(浅解) | Beet's blog, a frontEnd lover's blog site">
		<meta property="og:description" content=" Beet's blog, share &amp; blogging">
	    <link rel="icon" href="/static/assets/favicon.ico">
	    
	    
      <script src="/static/main.js" defer=""></script>
      <script src="https://cdn.jsdelivr.net/npm/turbolinks@5.2.0/dist/turbolinks.min.js"></script>
	  </head><body>
	    <main class="main">
		
	<article class="article">
	    <h1 class="title">BrowserStack-JS引擎机理(浅解)</h1>
	    <div class="location content">
		<a href="/">Home</a> /posts/15/<br>
		<time datetime="Posted date: 2020 Jul 21">Posted date: 2020 Jul 21</time>
	    </div>
	    <div class="content">
		<h3>首先从加载 js 说起</h3>
<p><strong>浏览器如何加载 js 的</strong></p>
<p>简单来说，在读取HTML文档时，遇到 <code>&lt;script&gt;</code> 标签，就开始下载 js 文档，下载完毕立即执行（这两个过程都是同步的，也就是说先暂停对html的读取，等js下载执行才能继续读取）</p>
<p><strong>defer async</strong></p>
<p>可以看到上面的方法是同步执行的，为了优化，通过在 <code>&lt;script&gt;</code> 标签里加上 defer 或 async，可以达到异步处理的效果，两者区别就是前者在HTML加载完成之后再执行js，后者是在下载完马上执行js</p>
<blockquote>
<p>注意：,defer 和 async只能在加载外部js文件才有作用，直接写在 html 文档里面的不会生效</p>
</blockquote>
<h3>先说JS引擎极大作用</h3>
<blockquote>
<p>所谓的代码引擎、运行引擎、垃圾回收引擎只是方便理解编出来的词条，官方没有相关说法，把它们都当成强大的 js 引擎就对了。</p>
</blockquote>
<ul>
<li>原始代码相关(涉及读、编译、优化等) ——&gt; 代码引擎</li>
<li>代码运行相关(涉及事件循环) ——&gt; 运行引擎</li>
<li>垃圾回收相关 ——&gt; 垃圾回收引擎</li>
<li>其他引擎</li>
</ul>
<h3>JS 代码引擎</h3>
<p>这里标题说所的代码引擎是指引擎对代码的处理操作。</p>
<blockquote>
<p>JS代码引擎的组件预览</p>
<ul>
<li>Parser</li>
<li>AST</li>
<li>Interpreter</li>
<li>Profiler（JIT）</li>
<li>Compiler（JIT）</li>
<li>Optimized code（JIT）</li>
</ul>
</blockquote>
<blockquote>
<p>前奏：在下载js文件时，读取就已经开始了(这样下载完就可以立即执行)，我们知道，下载过程传输的是<code>字节</code>，那么就可以说js文件就是一个<code>字节流</code>，通过字节流解码系统，把下载的字节解码成 <code>进制编码</code>
比如采用16进制编码，得到的进制编码就可能是  <code>2c 25 34...</code>。</p>
</blockquote>
<h4>Parser（读取）</h4>
<p>AST(Abstract syntax tree)，他的工作是在 <code>Parser</code> 得到 <code>进制编码</code> 后，将其解码成 <code>tokens</code></p>
<blockquote>
<p>承接上文，这一步得到的就是 <code>let...</code></p>
</blockquote>
<h4>AST (生成语法数)</h4>
<p>得到 <code>tokens</code> 后，再将其根据语法规范创建node节点，进而构建 <code>syntax tree</code> 数据结构。</p>
<blockquote>
<p>具体大概就是js根据tokens判断关键字和保留字，分类和标记各个不同代码段的不同功能，方便解释代码</p>
</blockquote>
<p>比如我们在编辑器里写的一段代码：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fooMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'syntax'</span><span class="token punctuation">)</span> <br>  <br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tree'</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">printTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fooMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <br><span class="token punctuation">}</span></code></pre>
<p>通过前三步生成的 <code>syntax tree</code> 使用JSON可以表示如下[显示太长请右上角折叠]</p>
<blockquote>
<p>注：https://astexplorer.net/ 是一个很好用的AST生成工具</p>
</blockquote>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Program"</span><span class="token punctuation">,</span><br>  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>  <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span><br>  <span class="token property">"body"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"FunctionDeclaration"</span><span class="token punctuation">,</span><br>      <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>      <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">47</span><span class="token punctuation">,</span><br>      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span><br>        <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span><br>        <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span><br>        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"fooMe"</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token property">"expression"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      <span class="token property">"generator"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      <span class="token property">"async"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token property">"body"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"BlockStatement"</span><span class="token punctuation">,</span><br>        <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">17</span><span class="token punctuation">,</span><br>        <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">47</span><span class="token punctuation">,</span><br>        <span class="token property">"body"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>          <span class="token punctuation">{</span><br>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"ExpressionStatement"</span><span class="token punctuation">,</span><br>            <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span><br>            <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">41</span><span class="token punctuation">,</span><br>            <span class="token property">"expression"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"CallExpression"</span><span class="token punctuation">,</span><br>              <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span><br>              <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">41</span><span class="token punctuation">,</span><br>              <span class="token property">"callee"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"MemberExpression"</span><span class="token punctuation">,</span><br>                <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span><br>                <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">31</span><span class="token punctuation">,</span><br>                <span class="token property">"object"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span><br>                  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span><br>                  <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">27</span><span class="token punctuation">,</span><br>                  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"console"</span><br>                <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                <span class="token property">"property"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span><br>                  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">28</span><span class="token punctuation">,</span><br>                  <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">31</span><span class="token punctuation">,</span><br>                  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"log"</span><br>                <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                <span class="token property">"computed"</span><span class="token operator">:</span> <span class="token boolean">false</span><br>              <span class="token punctuation">}</span><span class="token punctuation">,</span><br>              <span class="token property">"arguments"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token punctuation">{</span><br>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Literal"</span><span class="token punctuation">,</span><br>                  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span><br>                  <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">40</span><span class="token punctuation">,</span><br>                  <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"syntax"</span><span class="token punctuation">,</span><br>                  <span class="token property">"raw"</span><span class="token operator">:</span> <span class="token string">"'syntax'"</span><br>                <span class="token punctuation">}</span><br>              <span class="token punctuation">]</span><br>            <span class="token punctuation">}</span><br>          <span class="token punctuation">}</span><br>        <span class="token punctuation">]</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"FunctionDeclaration"</span><span class="token punctuation">,</span><br>      <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">49</span><span class="token punctuation">,</span><br>      <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">88</span><span class="token punctuation">,</span><br>      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span><br>        <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">58</span><span class="token punctuation">,</span><br>        <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">61</span><span class="token punctuation">,</span><br>        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"foo"</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token property">"expression"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      <span class="token property">"generator"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      <span class="token property">"async"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token property">"body"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"BlockStatement"</span><span class="token punctuation">,</span><br>        <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span><br>        <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">88</span><span class="token punctuation">,</span><br>        <span class="token property">"body"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>          <span class="token punctuation">{</span><br>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"ExpressionStatement"</span><span class="token punctuation">,</span><br>            <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">67</span><span class="token punctuation">,</span><br>            <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">86</span><span class="token punctuation">,</span><br>            <span class="token property">"expression"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"CallExpression"</span><span class="token punctuation">,</span><br>              <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">67</span><span class="token punctuation">,</span><br>              <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">86</span><span class="token punctuation">,</span><br>              <span class="token property">"callee"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"MemberExpression"</span><span class="token punctuation">,</span><br>                <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">67</span><span class="token punctuation">,</span><br>                <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">78</span><span class="token punctuation">,</span><br>                <span class="token property">"object"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span><br>                  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">67</span><span class="token punctuation">,</span><br>                  <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">74</span><span class="token punctuation">,</span><br>                  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"console"</span><br>                <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                <span class="token property">"property"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span><br>                  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">75</span><span class="token punctuation">,</span><br>                  <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">78</span><span class="token punctuation">,</span><br>                  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"log"</span><br>                <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                <span class="token property">"computed"</span><span class="token operator">:</span> <span class="token boolean">false</span><br>              <span class="token punctuation">}</span><span class="token punctuation">,</span><br>              <span class="token property">"arguments"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token punctuation">{</span><br>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Literal"</span><span class="token punctuation">,</span><br>                  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">79</span><span class="token punctuation">,</span><br>                  <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">85</span><span class="token punctuation">,</span><br>                  <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"tree"</span><span class="token punctuation">,</span><br>                  <span class="token property">"raw"</span><span class="token operator">:</span> <span class="token string">"'tree'"</span><br>                <span class="token punctuation">}</span><br>              <span class="token punctuation">]</span><br>            <span class="token punctuation">}</span><br>          <span class="token punctuation">}</span><br>        <span class="token punctuation">]</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"FunctionDeclaration"</span><span class="token punctuation">,</span><br>      <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">90</span><span class="token punctuation">,</span><br>      <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span><br>      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span><br>        <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">99</span><span class="token punctuation">,</span><br>        <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">108</span><span class="token punctuation">,</span><br>        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"printTree"</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token property">"expression"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      <span class="token property">"generator"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      <span class="token property">"async"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token property">"body"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"BlockStatement"</span><span class="token punctuation">,</span><br>        <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">111</span><span class="token punctuation">,</span><br>        <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">146</span><span class="token punctuation">,</span><br>        <span class="token property">"body"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>          <span class="token punctuation">{</span><br>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"ExpressionStatement"</span><span class="token punctuation">,</span><br>            <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">114</span><span class="token punctuation">,</span><br>            <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">142</span><span class="token punctuation">,</span><br>            <span class="token property">"expression"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"CallExpression"</span><span class="token punctuation">,</span><br>              <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">114</span><span class="token punctuation">,</span><br>              <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">142</span><span class="token punctuation">,</span><br>              <span class="token property">"callee"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"MemberExpression"</span><span class="token punctuation">,</span><br>                <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">114</span><span class="token punctuation">,</span><br>                <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">125</span><span class="token punctuation">,</span><br>                <span class="token property">"object"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span><br>                  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">114</span><span class="token punctuation">,</span><br>                  <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">121</span><span class="token punctuation">,</span><br>                  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"console"</span><br>                <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                <span class="token property">"property"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span><br>                  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">122</span><span class="token punctuation">,</span><br>                  <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">125</span><span class="token punctuation">,</span><br>                  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"log"</span><br>                <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                <span class="token property">"computed"</span><span class="token operator">:</span> <span class="token boolean">false</span><br>              <span class="token punctuation">}</span><span class="token punctuation">,</span><br>              <span class="token property">"arguments"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token punctuation">{</span><br>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"BinaryExpression"</span><span class="token punctuation">,</span><br>                  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">126</span><span class="token punctuation">,</span><br>                  <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">141</span><span class="token punctuation">,</span><br>                  <span class="token property">"left"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"CallExpression"</span><span class="token punctuation">,</span><br>                    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">126</span><span class="token punctuation">,</span><br>                    <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">133</span><span class="token punctuation">,</span><br>                    <span class="token property">"callee"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span><br>                      <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">126</span><span class="token punctuation">,</span><br>                      <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">131</span><span class="token punctuation">,</span><br>                      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"fooMe"</span><br>                    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                    <span class="token property">"arguments"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br>                  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                  <span class="token property">"operator"</span><span class="token operator">:</span> <span class="token string">"+"</span><span class="token punctuation">,</span><br>                  <span class="token property">"right"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"CallExpression"</span><span class="token punctuation">,</span><br>                    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">136</span><span class="token punctuation">,</span><br>                    <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">141</span><span class="token punctuation">,</span><br>                    <span class="token property">"callee"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>                      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span><br>                      <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">136</span><span class="token punctuation">,</span><br>                      <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">139</span><span class="token punctuation">,</span><br>                      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"foo"</span><br>                    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                    <span class="token property">"arguments"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br>                  <span class="token punctuation">}</span><br>                <span class="token punctuation">}</span><br>              <span class="token punctuation">]</span><br>            <span class="token punctuation">}</span><br>          <span class="token punctuation">}</span><br>        <span class="token punctuation">]</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">"sourceType"</span><span class="token operator">:</span> <span class="token string">"module"</span><br><span class="token punctuation">}</span></code></pre>
<h4>Interpreter（解释器）</h4>
<p>v8里的Interpreter叫做 <code>Ignition</code>
解释器会遍历 <code>AST</code> ，生成 <code>byte code</code>（字节码），等到字节码全部生成完毕，马上就从内存清除。</p>
<p>解释器出来的代码已经可以执行，但是没有经过优化，只是一行一行傻傻的执行，现在大多数浏览器js内核都使用JIT把它编译成<code>optimized code</code>，并结合<code>byte code</code>， 可以大大优化执行的效率。</p>
<p>所以得出结论，<code>byte code</code>和<code>optimized code</code>都是最后（经过一点编译）可以执行的代码。</p>
<blockquote>
<p><code>RUNTIME</code>下文会讲到</p>
</blockquote>
<h4>JIT Compiler(实时编译优化)</h4>
<p>现在许多流行的编译器都实现了JIT(just-in-time compiler)编译器，v8的JIT叫做 <code>TurboFan JIT</code>，他可以在 <code>RUNTIME</code> 实时编译出优化的机器代码，JIT分以下三个操作 =&gt; <strong>三个操作各自占有自己的线程，可异步执行</strong></p>
<ul>
<li>
<p>Profiler（监视器）</p>
<p>在<code>RUNTIME</code>过程中，<code>profiler</code>会监控和记录那些需要优化的部分，以便最后的优化操作</p>
</li>
<li>
<p>Compiler (编译成机器码)</p>
<p>也叫翻译器，将上文的 <code>byte code</code> 翻译成机器能看懂的 <code>machine code</code>。</p>
</li>
<li>
<p>Optimized code（优化机器码）</p>
<p>结合profiler的信息优化机器码，发送给compiles，最终得到优化后的代码</p>
</li>
</ul>
<p>以上便是读取、编译代码的整个流程，可以总结如下</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAANCAIAAADTzFK5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAACQklEQVQoz42S208aQRTG/acbHnwwlra2NUoTjVW0D72EmtJQrDVgGmyALWARlvsd5LbLbZll2dmd3WVn6CCl1caoX75MMpOT3zlzzlmaEkx0YABWabrh5Ue5w7TaxXild17gk5eDRB0wRcGX7WfaUn+skZmm1LdqacZCvMafSLmXUnoV1L6kc9GjcPnQn/fE6h6WOwy33jHNUGnIiSpZaDqd+1ZWxyvlN6TsM7F+lM5fzFneWP00yTnP245QK1IZ8iLChEb/Le5/HGURYiqm0jRGGWod8mAE6j2pyoPWQGwNQK07oB5KI6TJxIQ0eGaMCDZoHdcLXLo6r+5Xyeaa5TfRROuOQIbjQ832T6H/SxhE+X6kzAeb3RAASQNxBKvkQazJSBmlS+VPvsimh1lnU/Zk7k04s/f1whZM7VQvnarIEgMsevePdVNznN6DQrCQ2fL5LZ6zR2zUysafBi9WXYwlEF2p5LeU3g/a6HtY89ImWkcWgs2yPZNYY2Nr1fRmLfeqmLMlsuvVgk2o7OuUBVtkPoO7WQYd7pBBjfdaeU8r2FFpXy3souwOSm7rqe1J/sDkZ6zpQ1im3tX6ARh/PfZYpc8rku/5+PQJPHksv7VA57IW2Jw0vhPa/rtZi0+CyTCG4h/kbxvjwzXo24LeDeh+Ie0uyw6rxhyYXIgYwoN6T+eN5YZeYVDkWD1zIdaLosdqyK2cOJDfZRT9WKwSDO9j/VkRk5gq0QCGPTzuYqWPYRdLHSxyWO7Qd7qxNOb6rv4Grwt55hKLnuYAAAAASUVORK5CYII=" alt="" data-src="https://m.beetcb.com/postimg/15/1.png" class="lazyload" width="1280" height="676"></p>
<hr>
<h3>JS 运行引擎</h3>
<p><code>RUNTIME</code> 是指 js 代码运行时的环境。js 引擎参与（也处在）这个环境中。理解这个环境对 js 中的同步与异步很用帮助</p>
<blockquote>
<p>概括：
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAUCAIAAAD3FQHqAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAE/0lEQVQ4y22Ue0xTdxTHf7ddSlIt4Ktz2dRkPhJH9u+2vxyTOuNIfEadvNSpQ9ctzvmoiF3MJqWYMVyYTBiU2mB5WEAYCoXSB+VVaC33FhBogb7u7b29heKGPMyy7LRDZ9y+OTn9/dr+Pvfc8zvnoKKiourq6ocPH+bn52dmZiYnJx84cCAlJSU1NTUjIyM1KtimpaWlp6fDN0ej+vTIkd179pw5c6agoKC5uVmtVt+8eRNVVFTodLqBgQEgXr9+/fTp02fPnr0UVVZWFniJRHLx4sXLEglss7Ozr0Z14fyFL8VimUym0WhwgtBqtaWlpaixsdFqtXq9XpPJBFx4TmFhYUlJiVKprKqqunfvHvy7Bj5qaipKSsry8n65Ki2+dq1QKs2XSMpycppLyxytrTqNRgWshoYGi8Xi8XgGBwdhAUSDwdDR0dHX14fj+OOoRkZGhnC8R12pzbpSd/jTxrT0pmPHm0+c1J482X7qlPmb8/elUkVe3hJrcnJydHR0eHh4KCo4DHSaDkxFFJoKT7Met7OszHbwYOf69f0bN+JbtxIJCbZNm3rfWmdJSGjau1d56RKqq6vr6emZfK7x8XGXyzUxMUGSJE0HGSZE0yEyEPI9drp+KBj5MHGYw3FyOB4ul+RyAxxOAMMoobAnKany3DlUW1trNpvhPID8fr/P53O73RAURVEMM0nTgxRp8ZG95IjO/+MVMvF9moNNI/QUoUWE/sSwv8ALhYNJSRpgQVohQfB2TqcTbuAFKxAgQ6FullVRpNTrz6bGzlM/JZPb3yYxxCI0i9ACQs8ABF4odLxgGY1GSNA/LGpJAYahwmHNTFg8FXo3GEqY8b8zXfwms3M5yUFBDM28ZL8LhfZXWGNjYxAOuSSKpsmZGcWTJ/unQjFMkBv2csO3MXYnAhaFIQZDdMSwIIaFha//DwtSDqF5IvL6/e5g8FeW3RcI8L3+GHqCxypfYzM4gS0YtRkjI8b1beH5N/OY9zb0H9xVc1nyKisK8vj8JMP46aDC5tpf188v0vNKdbxKBb9eGvvbsRUNGfH1aYLa1Dh1iqDiML/y2Ibyr3fd+u45CwoS8gX3yDAMywanpqafzISoGfX9iUNZ/YLdbTH72mOOaJd/1hifWbP68+pVJ6rij6tXpqhjD93lp9Ws+6p857dFF/6NC2qCZdnZ2dm5ubn5hYVnC3PkU/0tt3iHbT3fyOObeXF9y9bYV7xBrFmLrxYOrFz9aEWcbRnfHrNmaNW29m1fqMSR+oKOgZqAEgPW/Pz84uLi/ML8wtyc9w/8Z/b7j6kPYn3xAjJOEIhYLAkG23iBP05AxfJDy9bOrk10JIprxQjGRVtbG5R+b28vQRBQ9xCga9zlnnQPuQfLXeVil1g0tkPkFImcUT8mShoViZ7bRxPbP/ElH+0+KrkrQSqVqqWlpbOzE7oaGqAnKuhQ+yO7lbA22Btu47dzBnJycFnOgEyGy3Lx3FxCLifkuUQueJlDdmPohrxNLi+XIxgskC+Hw2G32202G0TX3d0NLFhbbdaOrg5Dp8HUbQIzdhnNFnMf3keMEI7RJSMi3tHa3npHdScyC+EdiagAByyIsTeqrq4ufbter9ObDCajwWjQG8wmc7+ln8AJB+542bQtWmW5EikUChiHEAucBA/3AGFCh+r1enjGgwcPmpqaYArDEIc1ZAN+6vqP6uvri4uL/waTVbN94GaJwAAAAABJRU5ErkJggg==" alt="" data-src="https://m.beetcb.com/postimg/15/2.png" class="lazyload" width="700" height="561"></p>
<ul>
<li>Memory Heap</li>
<li>Call Stack</li>
<li>Web APIs</li>
<li>Callback Queue</li>
<li>Event loop</li>
</ul>
</blockquote>
<p>如上 <code>RUNTIME</code> 里一共有五个容器。其实在上面处理代码的过程中，js 就已经将其不同的代码放入对应的容器中。</p>
<h4>Memory Heap</h4>
<p>内存堆，在处理代码过程中，储存对象类型值</p>
<h4>Call Stack</h4>
<p>调用栈是追踪函数执行流的一种机制，在处理代码的过程中，遇到函数执行就放到调用栈中。每个调用都在栈中开辟一个空间，这个空间叫 <code>call frame</code> （调用帧，储存当前函数的调用位置、变量信息）</p>
<p>Call Stack 满足<a href="https://en.wikipedia.org/wiki/Stack_(abstract_data_type)">栈数据结构LIFO</a>的特点。</p>
<p>它在 <code>RUNTIME</code> 里处理的机制是；</p>
<ul>
<li>在函数被放入栈中时，web apis会验证当前函数是否需要等待执行，如果是，立即抽出加入web apis</li>
<li>一旦有立即执行的函数调用，立即放入栈的头部</li>
<li>在头部的调用立即执行</li>
<li>执行完毕的函数立即从stack中清除</li>
<li>当调用次数过多时会发生 <code>stack overflow</code></li>
</ul>
<p>因为 js 是单线程（<code>single thread</code>）的，代码运行期间只能有一个 <code>call stack</code>，但是因为有了机制的第一条，js 拥有了异步处理的能力；具体处理请往下读。</p>
<blockquote>
<p>补充：callstack可以在浏览器的 <code>inspect -&gt; sources -&gt; callstack</code> 使用 debug 查看过程。</p>
</blockquote>
<h4>Web APIs</h4>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API">Web APIs</a> 是浏览器提供的接口，js 调用十分方便, 常用的有 <code>DOM</code> <code>CSSOM</code> <code>Timer</code> 等。
在 <code>RUNTIME</code> 里，Web APIs有利用<code>AJAX requests</code> 、 <code>setTimeout</code> 、 <code>DOM 里的 EventTarget</code>等等完成异步处理。</p>
<p>web apis不断验证等待执行的函数，当等待条件不在满足时，立刻抽出并加入到<code>callback queue</code></p>
<h4>Callback Queue</h4>
<p>回调队列，FIFO原则，先进先执行，当 <code>event loop</code> 触发后，回调队列满足FIFO的那个事件被抽出，加入到 <code>call stack</code> 中。</p>
<h4>Event Loop</h4>
<p>事件循环，它的任务是不断检测当前 <code>call stack</code> 是否为空，若为空，触发回调队列</p>
<p>实列演示可以通过<a href="http://latentflip.com/loupe/?code=JC5vbignYnV0dG9uJywgJ2NsaWNrJywgZnVuY3Rpb24gb25DbGljaygpIHsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gdGltZXIoKSB7CiAgICAgICAgY29uc29sZS5sb2coJ1lvdSBjbGlja2VkIHRoZSBidXR0b24hJyk7ICAgIAogICAgfSwgMjAwMCk7Cn0pOwoKY29uc29sZS5sb2coIkhpISIpOwoKc2V0VGltZW91dChmdW5jdGlvbiB0aW1lb3V0KCkgewogICAgY29uc29sZS5sb2coIkNsaWNrIHRoZSBidXR0b24hIik7Cn0sIDUwMDApOwoKY29uc29sZS5sb2coIldlbGNvbWUgdG8gbG91cGUuIik7!!!PGJ1dHRvbj5DbGljayBtZSE8L2J1dHRvbj4%3D"> Philip Robert’s tool </a> 很方便地查看动画演示</p>
<h3>JS 垃圾回收引擎(只说标记清除)</h3>
<p>垃圾回收（Garbage collection）主要目的是清理内存，提高运行速度
c 语言提供<code>malloc()</code> <code>free()</code>来实现手动释放内存；
而js 垃圾回收是自动的，它的机制就是从根对象开始，向下定期检查是否有<strong>不可达</strong>的对象，是则不再需要，应该对其回收。</p>
<h3>其他引擎</h3>
<p>在js机制中，还有其他用于优化的机制 <code>shaps</code> <code>Inline Caches</code>，笔者还没研究，在此不去深入。</p>
<p>可以参考 <a href="https://mathiasbynens.be/notes/shapes-ics">avaScript engine fundamentals: Shapes and Inline Caches</a> 去深入了解</p>
<p><a href="https://v8.dev/blog/turbofan-jit">Digging into the TurboFan JIT</a></p>
<p><a href="https://medium.com/@sanderdebr/a-brief-explanation-of-the-javascript-engine-and-runtime-a0c27cb1a397">A brief explanation of the Javascript Engine and Runtime</a></p>
<p><a href="https://blog.sessionstack.com/how-javascript-works-inside-the-v8-engine-5-tips-on-how-to-write-optimized-code-ac089e62b12e">How JavaScript works: inside the V8 engine + 5 tips on how to write optimized code
</a></p>
<blockquote>
<p>欢迎指正、讨论</p>
</blockquote>

	    </div>
	    <div class="outline"></div>
	</article>

     
		</main>
		<footer class="footer">
		    <div class="footer-desc">
			made with love&amp;<a style="color: skyblue;" href="https://www.11ty.dev/" target="_blank">11ty</a> by beet <br> 
			<a href="http://www.beian.miit.gov.cn/" target="_blank">ICP-20003648-1</a>
		    </div>
		</footer>
	    <script>
            (function (selector, src, preferNativeLazyLoad) {
  var images = document.querySelectorAll(selector);
  var numImages = images.length;

  if (numImages > 0) {
    if (preferNativeLazyLoad && 'loading' in HTMLImageElement.prototype) {
      for (var i = 0; i < numImages; i++) {
        var keys = ['src', 'srcset'];

        for (var j = 0; j < keys.length; j++) {
          if (images[i].hasAttribute('data-' + keys[j])) {
            var value = images[i].getAttribute('data-' + keys[j]);
            images[i].setAttribute(keys[j], value);
          }
        }
      }

      return;
    }

    var script = document.createElement('script');
    script.async = true;
    script.src = src;
    document.body.appendChild(script);
  }
})(
              'img',
              'https://m.beetcb.com/lib/lazysizes.min.js',
              false
            );
          </script></body></html>