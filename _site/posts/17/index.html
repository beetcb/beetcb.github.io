<!DOCTYPE html>
<html lang="en"><head>
	    <meta charset="UTF-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	    <meta name="description" content="a beginer theme based blog project with 11ty">
	    <title>beet-11ty</title>
	    <link rel="stylesheet" href="/src/css/my.css">
	    <link rel="stylesheet" href="/src/css/prism-dracula.css">
	    <link rel="shortcut icon" href="/src/favicon.ico" type="image/x-icon">
	    <script defer src="/src/js/my.js"></script>
	    </head><body>
		<main class="main">
		
	<article style="margin: 0 auto" class="article">
	    <h1 class="title">读Openssh Manual</h1>
	    <div class="content">
		<blockquote>
<p>第一次去深入了解 openssh ，此篇是我的学习笔记。本文使用的 ip 地址均替换成了某厂 CDN 地址，所以热心的朋友不必去尝试 ** 啦  (✿◡‿◡) 。</p>
</blockquote>
<h3>Openssh概览</h3>
<p><strong><a href="https://en.wikipedia.org/wiki/Secure_Shell"><code>ssh</code></a>（secure shell） 是一种加密的网络传输协议。</strong></p>
<p>为实现服务器的远距离访问和信息传输，最初的 <code>telnet</code> 协议诞生。但是传输的明文信息暴露在网络，(若密码不可靠)很容易被监听，使得 <code>telnet</code> 协议并不安全。</p>
<p>自然，<code>ssh</code> 以其安全性替代了 <code>telnet</code> ，对远程连接进行身份验证、内容加密。</p>
<p><code>Openssh</code> 是对ssh协议开源的实现，还集成了许多工具。其基本功能是登陆远端服务器，执行一系列的操作，很是方便。</p>
<p><code>Openssh</code> 在各大操作系统广泛支持（内置），包括 win10（1809后）、macOS、Linux等。所以，前文所说的<strong>服务器</strong>，也可以普适到<strong>绝大多数电脑</strong></p>
<hr>
<h3>Openssh 三类工具</h3>
<h3>1.远程操作工具</h3>
<h4>a.<code>ssh</code>:远程登陆客户端</h4>
<ul>
<li>
<p>作用</p>
<p>远程登陆执行命令(还可把远端执行的命令结果返回客户端输出)，除此之外，SSH也支持隧道协议、端口映射和X11连接。</p>
</li>
<li>
<p>身份验证方式（密码和密钥）</p>
<p>1.密码验证</p>
<p>密码验证采用普通的 <code>用户名+密码</code> 验证方式, 需要手动输入密码</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 与当前客户端用户名匹配</span><br><span class="token function">ssh</span> <span class="token number">221.236</span>.11.90<br><span class="token comment"># 使用指定的用户名root</span><br><span class="token function">ssh</span> root@221.236.11.90</code></pre>
<p>2.密钥验证</p>
<p>密钥验证使用不对称的 <code>公钥、私钥</code> 进行验证，公钥需要提前放到服务端电脑中，私钥自己保管。</p>
<p>公钥不太重要，私钥最重要，使用密钥验证时不需要输入密码(使用私钥密码 <code>passphrase</code> 列外)</p>
<p>拿 github 的 ssh 配置举个栗子</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 使用ssh-keygen 生成密钥，会提示公钥的保存位置</span><br>ssh-keygen -t rsa -b <span class="token number">4096</span> -C <span class="token string">"zhparnex@gmail.com"</span> <span class="token comment"># 输入passphrase或者留空</span><br><br><span class="token comment"># 查看公钥id_rsa.pub</span><br><span class="token function">cat</span> ~/id_rsa.pub <span class="token comment"># 然后将公钥添加到github账号</span><br><br><span class="token comment"># 使用ssh进行git clone操作</span><br><span class="token function">git</span> clone git@github.com:beetcb/blog-backup.git </code></pre>
<p>3.执行返回，不进入远端shell</p>
<p>在<code>ssh 221.236.11.90</code>后面追加需要执行的命令，则不进入远端shell, 将远端output传输到本地客户端来output。也支持标准输入、输出、错误的重定向，下面是几个实用重定向操作(可以使用pipeline)。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 简单的输出重定向</span><br><span class="token function">ssh</span> <span class="token number">221.236</span>.11.90 <span class="token function">ls</span> -Alh <span class="token operator"><span class="token file-descriptor important">1</span>></span>ls.log <span class="token comment"># 数字1可省略</span><br><br><span class="token comment"># 利用输出重定向接收文件</span><br><span class="token function">ssh</span> <span class="token number">221.236</span>.11.90 <span class="token string">'cat remotefile.zip'</span> <span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token function">pv</span> filefromremote.zip<br><br><span class="token comment"># 利用输入重定向发送文件</span><br><span class="token function">ssh</span> <span class="token number">221.236</span>.11.90 <span class="token function">cat</span> <span class="token operator"><span class="token file-descriptor important">1</span>></span> filefromlocal.zip <span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span> localfile.zip <span class="token comment"># 可以省略0</span><br><br><span class="token comment"># 发送接收文件夹或多个文件，需要使用pipeline简化操作</span><br><span class="token function">ssh</span> <span class="token number">221.236</span>.11.90 <span class="token function">tar</span> Jc bin/* <span class="token operator">|</span> <span class="token function">tar</span> xJ <br><span class="token function">tar</span> Jc bin/* <span class="token operator">|</span> <span class="token function">ssh</span> -v <span class="token number">221.236</span>.11.90 <span class="token function">tar</span> xJ</code></pre>
</li>
<li>
<p><code>ssh [option]</code>选项一角</p>
<p>选项很多，忘记时就查阅manual，列出几个常用的：</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 指定ssh自定义端口</span><br><span class="token function">ssh</span> -p <span class="token number">2222</span> <span class="token number">221.236</span>.11.90 <span class="token comment"># 端口需要在服务端修改`sshd_config`文件</span><br><br><span class="token comment"># ssh 指定用户名的另一种写法</span><br><span class="token function">ssh</span> -l root <span class="token number">221.236</span>.11.90<br><br><span class="token comment"># debug </span><br><span class="token function">ssh</span> -v <span class="token number">221.236</span>.11.90<br><span class="token comment">## debug更改输出避免污染控制台</span><br><span class="token function">ssh</span> -v <span class="token number">221.236</span>.11.90 <span class="token operator"><span class="token file-descriptor important">2</span>></span>debug.log<br><span class="token comment">### or</span><br><span class="token function">ssh</span> -v -E debug.log <span class="token number">221.236</span>.11.90<br><span class="token comment">## 查看Exit status</span><br><span class="token function">ssh</span> -v <span class="token number">221.236</span>.11.90 <span class="token function">ls</span> -Ah <span class="token operator"><span class="token file-descriptor important">2</span>></span>debug.log<span class="token operator">&amp;&amp;</span><span class="token function">cat</span> debug.log <span class="token operator">|</span> <span class="token function">grep</span>  <span class="token string">' Exit status'</span><br><span class="token comment">## 仅查看debug信息，替代输出</span><br><span class="token function">ssh</span> -v <span class="token number">221.236</span>.11.90 <span class="token function">ls</span> -Ah <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span><br><br><span class="token comment"># 压缩传输[适合下行小的机器]</span><br><span class="token function">scp</span> -C debug.log <span class="token number">221.236</span>.11.90:. <span class="token comment"># 采用gzip压缩算法，如果网速很快，会降低传输速度</span><br><br><span class="token comment"># 安静模式</span><br><span class="token function">scp</span> -q <span class="token number">2222</span> debug.log <span class="token number">221.236</span>.11.90:. </code></pre>
</li>
</ul>
<h4>b.<code>scp</code>和<code>sftp</code>:加密文件传输</h4>
<p><code>scp</code> 可替代 rcp ，使用ssh传输和加密文件。scp 与 ssh 更改输入输出传输传输相比，scp 有进度条、网速显示，而且操作更简单、多文件或目录也不需要压缩再传输（当然ssh方法也可以使用pv）</p>
<p>scp 的基本格式：</p>
<p><code>scp -[options] [arguments] &lt;push location&gt; &lt;pull location&gt;</code></p>
<p><code>scp</code> 大部分参数继承ssh参数（<code>-p</code>改变），常用的有：</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 当前目录地文件传到远端$HOME目录</span><br><span class="token function">scp</span> debug.log <span class="token number">221.236</span>.11.90:. <span class="token comment"># 远端目录用 user@host:/tem/ 表示</span><br><br><span class="token comment"># 远端$HOME目录文件拉取到本地当前目录</span><br><span class="token function">scp</span> root@221.236.11.90:node.zip <span class="token builtin class-name">.</span><br><br><span class="token comment"># 目录传输</span><br><span class="token function">scp</span> -r root@221.236.11.90:Downloads <span class="token builtin class-name">.</span> <span class="token comment"># tab 键可以实现远端目录补全</span><br><br><span class="token comment"># 指定端口</span><br><span class="token function">scp</span> -P <span class="token number">2222</span> debug.log <span class="token number">221.236</span>.11.90:.<br><br><span class="token comment"># 保留文件修改次数</span><br><span class="token function">scp</span> -p <span class="token number">2222</span> debug.log <span class="token number">221.236</span>.11.90:.</code></pre>
<p><code>sftp</code> 可替代 ftp ，使用ftp + ssh传输文件，有ftp的功能，ssh的特性。与scp相比，sftp有操作文件的能力，而scp只能复制文件；另外sftp可以交互的，进入交互模式以后，可以进行基本的文件管理操作。</p>
<p>同样，<code>sftp</code> 大部分参数继承ssh参数（<code>-p</code>改变，类似于 <code>scp</code>）。此外，在交互模式下，还有它自己的一些命令及参数（输入<code>help</code>获得提示），下面是几个我了解的：</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 首先进入sftp交互模式</span><br><span class="token function">sftp</span> <span class="token number">221.236</span>.11.90<br><br><span class="token comment"># ls cd 用于导航</span><br>sftp<span class="token operator">></span> <span class="token function">ls</span><br><br><span class="token comment"># 下载文件(夹)到local进入sftp模式的目录</span><br>sftp<span class="token operator">></span> get file1.zip file2.zip<br>sftp<span class="token operator">></span> get -r remote_directory<br><br><span class="token comment"># 上传文件（夹）=> 从local进入的目录</span><br>sftp<span class="token operator">></span> put file1.zip file2.zip<br>sftp<span class="token operator">></span> put -r local_directory<br>sftp<span class="token operator">></span> put /file1.zip /file2.zip <span class="token comment"># 使用绝对路径</span><br><br><span class="token comment"># 如果get 和 put 失败，可以重试</span><br>sftp<span class="token operator">></span> reget -r remote_directory<br>sftp<span class="token operator">></span> reput -r local_directory</code></pre>
<p>此外，还有一些类似于linux的命令（下面的comment使用linux命令）</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># df mkdir rm chmod chown chgrp => same</span><br><br><span class="token comment"># mv(change name) => rename</span><br><span class="token function">rename</span> file.zip renamedFile.zip<br><span class="token comment"># exit => bye or exit</span><br><span class="token builtin class-name">exit</span> <br>bye<br><span class="token comment"># 'manual' => help</span><br><span class="token builtin class-name">help</span> <span class="token comment"># 显示帮助手册</span><br><span class="token comment"># ls (local) pwd (local) mkdir (local)=> add prefix `l`(local)</span><br>lcd ~ <span class="token comment"># 改变本地目录</span><br>lls <span class="token comment"># 列出本地目录</span><br>lpwd <span class="token comment"># 显示本地工作目录</span><br>lmkdir dirLocal <span class="token comment"># 在本地创建文件夹</span></code></pre>
<p>好了，这就是利用Openssh进行远程操作的工具了，其深入功能还有很多没有列出，需要持续学习。</p>
<h3>2.密钥管理工具</h3>
<h4>a.ssh-keygen</h4>
<p><code>ssh-keygen</code>主要用于生成密钥对（也能管理转换密钥），一个生成过程如下：</p>
<pre class="language-bash"><code class="language-bash">~ ssh-keygen<br>Generating public/private rsa key pair.<br>Enter <span class="token function">file</span> <span class="token keyword">in</span> <span class="token function">which</span> to save the key <span class="token punctuation">(</span>/home/ylo/.ssh/id_rsa<span class="token punctuation">)</span>: <br>Enter passphrase <span class="token punctuation">(</span>empty <span class="token keyword">for</span> no passphrase<span class="token punctuation">)</span>: <br>Enter same passphrase again: <br>Your identification has been saved <span class="token keyword">in</span> /home/ylo/.ssh/id_rsa.<br>Your public key has been saved <span class="token keyword">in</span> /home/ylo/.ssh/id_rsa.pub.<br>The key fingerprint is:<br>SHA256:Up6KjbnEV4Hgfo75YM393QdQsK3Z0aTNBz0DoirrW+c ylo@klar<br>The key's randomart image is:<br>+---<span class="token punctuation">[</span>RSA <span class="token number">2048</span><span class="token punctuation">]</span>----+<br><span class="token operator">|</span>    <span class="token builtin class-name">.</span>      <span class="token punctuation">..</span>oo<span class="token punctuation">..</span><span class="token operator">|</span><br><span class="token operator">|</span>   <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span>  <span class="token builtin class-name">.</span> .o.X.<span class="token operator">|</span><br><span class="token operator">|</span>    <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> o.  <span class="token punctuation">..</span>+ B<span class="token operator">|</span><br><span class="token operator">|</span>   <span class="token builtin class-name">.</span>   o.o  .+ <span class="token punctuation">..</span><span class="token operator">|</span><br><span class="token operator">|</span>    <span class="token punctuation">..</span>o.S   o<span class="token punctuation">..</span>  <span class="token operator">|</span><br><span class="token operator">|</span>   <span class="token builtin class-name">.</span> %o<span class="token operator">=</span>      <span class="token builtin class-name">.</span>  <span class="token operator">|</span><br><span class="token operator">|</span>    @.B<span class="token punctuation">..</span>.     <span class="token builtin class-name">.</span> <span class="token operator">|</span><br><span class="token operator">|</span>   o.<span class="token operator">=</span>. o. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span>  <span class="token builtin class-name">.</span><span class="token operator">|</span><br><span class="token operator">|</span>    .oo  E. <span class="token builtin class-name">.</span> <span class="token punctuation">..</span> <span class="token operator">|</span><br>+----<span class="token punctuation">[</span>SHA256<span class="token punctuation">]</span>-----+<br>klar <span class="token punctuation">(</span><span class="token number">11</span>:40<span class="token punctuation">)</span> ~<span class="token operator">></span></code></pre>
<p>过程中有两个选项：</p>
<ul>
<li>
<p>选择密钥保存位置，一般保持默认</p>
<p><code>Enter file in which to save the key (/home/ylo/.ssh/id_rsa):</code></p>
<p>同时可以指定文件名</p>
</li>
<li>
<p><code>passphrase</code>私钥密码</p>
<p><code>Enter passphrase (empty for no passphrase): </code></p>
<p>留空则不设定私钥密码，<code>passphrase</code> 是推荐使用的，如果觉得每次连接输入密码麻烦，可以使用 <code>ssh-add</code> <code>ssh-agent</code> 管理密钥[参见下文]。</p>
</li>
</ul>
<p>选项：</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 指定生成算法</span><br>ssh-keygen -t dsa <span class="token comment"># default：rsa</span><br><span class="token comment"># 指定生成大小</span><br>ssh-keygen -b <span class="token number">4096</span> <span class="token comment"># default: 2048</span><br><span class="token comment"># 提前指定储存位置和文件名</span><br>ssh-keygen -f ~/tatu-key-ecdsa -t ecdsa -b <span class="token number">521</span><br><span class="token comment"># 把公钥发送到服务器，写入 authorized_keys  文件</span><br>ssh-copy-id -i <span class="token number">221.236</span>.11.90 <span class="token comment"># 如果使用自定义设置，需要指定密钥位置</span><br><span class="token comment"># 测试是否连通成功</span><br><span class="token function">ssh</span> -i <span class="token number">221.236</span>.11.90</code></pre>
<blockquote>
<p><code>ssh-copy-id</code> 是如何工作的？</p>
<p>The command edits the authorized_keys file on the server. It creates the .ssh directory if it doesn't exist. It creates the authorized keys file if it doesn't exist. Effectively, ssh key copied to server.</p>
<p>It also checks if the key already exists on the server. Unless the -f option is given, each key is only added to the authorized keys file once.</p>
<p>It further ensures that the key files have appropriate permissions. Generally, the user's home directory or any file or directory containing keys files should not be writable by anyone else. Otherwise someone else could add new authorized keys for the user and gain access. Private key files should not be readable by anyone else.</p>
</blockquote>
<h4>b.ssh-add</h4>
<blockquote>
<p>建议先了解<code>ssh-agent</code>，初始的 ssh-agent 并没有储存私钥</p>
</blockquote>
<p><code>ssh-add</code> 的作用就是把私钥加入 <code>ssh-agent</code> 代为管理，这样私钥就会储存到内存中，而不是物理磁盘中。（<code>ssh-add</code> 也可以从 <code>ssh-agent</code> 移除私钥 ）</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 把默认的私钥加入ssh-agent管理</span><br>ssh-add <br><span class="token comment"># 移除私钥</span><br>ssh-add -d </code></pre>
<h4>c.ssh-keysign</h4>
<p><code>ssh-keysign</code> 是用于主机验证的帮助程序，默认关闭状态，需要修改ssh配置文件，使用几率不大（我就偷懒略过了）</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># modify /etc/ssh/ssh_config</span><br>HostbasedAuthentication <span class="token function">yes</span></code></pre>
<h4>d.ssh-keyscan</h4>
<p><code>ssh-keyscan</code> 可扫描收集远端服务器的公钥信息。主要用来提前验证设备指纹，加入 <code>known_hosts</code>。
简单来说就是我们在连接新远端主机时，会出现下面的指纹验证提示：</p>
<pre class="language-bash"><code class="language-bash">The authenticity of <span class="token function">host</span> <span class="token string">'221.236.11.90 (221.236.11.90)'</span> can't be established.<br>ECDSA key fingerprint is SHA256:kkX7M+KBwxX/Lz438A/ik/hvNkLFQbhqOfgUctr2UpI.<br>Are you sure you want to <span class="token builtin class-name">continue</span> connecting <span class="token punctuation">(</span>yes/no/<span class="token punctuation">[</span>fingerprint<span class="token punctuation">]</span><span class="token punctuation">)</span>?</code></pre>
<p>必须输入 <code>yes</code> 才能继续连接，但是如果我们正在写一个 shell 脚本，功能是遍历一群主机，有些是没有验证指纹的。在shell脚本里不可能输入 <code>yes</code>，需要用 <code>ssh-keyscan</code> 提前获取指纹写入 <code>known_hosts</code> 文件，下面是一个示例：</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># in script.sh</span><br>ssh-keyscan <span class="token variable">$2</span> <span class="token operator">>></span> ~/.ssh/known_hosts<br><span class="token function">ssh</span> <span class="token variable">$1</span>@<span class="token variable">$2</span><br><span class="token comment"># back to terminal</span><br>./script.sh root <span class="token number">221.236</span>.11.90</code></pre>
<p>下面是在命令含输出的一个展示：</p>
<pre class="language-bash"><code class="language-bash">~<br>△ <span class="token function">ssh</span> root@221.236.11.90<br>The authenticity of <span class="token function">host</span> <span class="token string">'221.236.11.90 (221.236.11.90)'</span> can't be established.<br>ECDSA key fingerprint is SHA256:kkX7M+KBwxX/Lz438A/ik/hvNkLFQbhqOfgUctr2UpI.<br>Are you sure you want to <span class="token builtin class-name">continue</span> connecting <span class="token punctuation">(</span>yes/no/<span class="token punctuation">[</span>fingerprint<span class="token punctuation">]</span><span class="token punctuation">)</span>? no<br>Host key verification failed.<br><br>~<br>▲ <span class="token function">cat</span> ~/script.sh<br><span class="token comment">#!/bin/bash</span><br>ssh-keyscan <span class="token variable">$2</span> <span class="token operator">>></span> ~/.ssh/known_hosts<br><span class="token function">ssh</span> <span class="token variable">$1</span>@<span class="token variable">$2</span><br><br>~<br>△  ./script.sh root <span class="token number">221.236</span>.11.90<br><span class="token comment"># 221.236.11.90:22 SSH-2.0-OpenSSH_7.4</span><br><span class="token comment"># 221.236.11.90:22 SSH-2.0-OpenSSH_7.4</span><br><span class="token comment"># 221.236.11.90:22 SSH-2.0-OpenSSH_7.4</span><br><span class="token comment"># 221.236.11.90:22 SSH-2.0-OpenSSH_7.4</span><br><span class="token comment"># 221.236.11.90:22 SSH-2.0-OpenSSH_7.4</span><br>Last login: Fri Aug  <span class="token number">7</span> <span class="token number">11</span>:41:44 <span class="token number">2020</span> from <span class="token number">43.227</span>.139.30<br><br>Welcome to Alibaba Cloud Elastic Compute Service <span class="token operator">!</span><br><br><span class="token punctuation">[</span>root@Ali ~<span class="token punctuation">]</span><span class="token comment">#</span></code></pre>
<h3>服务端工具 or 后台进程</h3>
<h4>a.ssh-agent</h4>
<blockquote>
<p>如果使用的是 <code>C Shell</code>，需要追加 <code>-s</code> 选项。</p>
</blockquote>
<p><code>ssh-agent</code> 程序可以跟踪 ssh 私钥 ，<code>ssh-agent</code> 的便利性在于可以不用每次输入 <code>passpharse</code> （只需初始输入一次），还可以在远程的机器上启用 <code>ssh-agent</code> 转发，使得远程机器可以使用本地转发给它的私钥进而连接其他的远程机器。可以参考  <a href="https://developer.github.com/v3/guides/using-ssh-agent-forwarding/">Using SSH agent forwarding</a> ，下面是一个简单的示例:</p>
<p><strong>注解：</strong></p>
<p>对两个环境变量的解释 =&gt;
<code>ssh</code> 与 <code>ssh-agent</code> 是两个单独的进程，需要通过 <code>ssh-agent</code> 的两个环境变量实现交流：</p>
<blockquote>
<ul>
<li><code>SSH_AGENT_PID</code>: 储存 ssh-agent 进程的 PID；</li>
<li><code>SSH_AUTH_SOCK </code>: 为实现进程通信。</li>
</ul>
</blockquote>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 通过使用eval启动它并且暴露它内部的环境变量（因为它不能自动暴露环境变量到shell中）</span><br><span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span>ssh-agent<span class="token variable">)</span></span> <span class="token comment"># 不暴露环境变量，就无法与ssh-agent沟通</span><br><span class="token comment">## or</span><br>ssh-agent <span class="token function">zsh</span><br><span class="token comment">## or</span><br><span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>ssh-agent<span class="token punctuation">)</span><br><br><span class="token comment"># ssh-add</span><br>ssh-add</code></pre>
<p>下面是对为何要使用eval的一个直观解释？</p>
<pre class="language-bash"><code class="language-bash">~<br>△ ssh-agent <br><span class="token assign-left variable"><span class="token environment constant">SSH_AUTH_SOCK</span></span><span class="token operator">=</span>/tmp/ssh-JcB99CiIGY8S/agent.192<span class="token punctuation">;</span> <span class="token builtin class-name">export</span> <span class="token environment constant">SSH_AUTH_SOCK</span><span class="token punctuation">;</span><br><span class="token assign-left variable">SSH_AGENT_PID</span><span class="token operator">=</span><span class="token number">193</span><span class="token punctuation">;</span> <span class="token builtin class-name">export</span> SSH_AGENT_PID<span class="token punctuation">;</span><br><span class="token builtin class-name">echo</span> Agent pid <span class="token number">193</span><span class="token punctuation">;</span><br><br>~<br>△ ssh-agent <span class="token function">zsh</span> <span class="token comment"># 与eval同效果</span><br><br>~<br>△ <span class="token function">env</span><br><span class="token assign-left variable"><span class="token environment constant">HOSTTYPE</span></span><span class="token operator">=</span>x86_64<br><span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8<br><span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/mnt/c/WINDOWS/system32:/mnt/c/WINDOWS:/mnt/c/WINDOWS/System32/Wbem:/mnt/c/WINDOWS/System32/WindowsPowerShell/v1.0/:/mnt/c/WINDOWS/System32/OpenSSH/:/mnt/c/ProgramData/chocolatey/bin:/mnt/c/Program Files/dotnet/:/mnt/c/Program Files/nodejs/:/mnt/c/Users/Administrator/AppData/Local/Microsoft/WindowsApps:/mnt/c/Users/Administrator/AppData/Local/Programs/Microsoft VS Code/bin:/mnt/c/Users/Administrator/AppData/Roaming/npm<br><span class="token assign-left variable"><span class="token environment constant">TERM</span></span><span class="token operator">=</span>xterm-256color<br><span class="token assign-left variable">WT_SESSION</span><span class="token operator">=</span><span class="token number">20284759</span>-5434-4f3d-8e8e-a9c6b1afe1dc<br><span class="token assign-left variable">WT_PROFILE_ID</span><span class="token operator">=</span><span class="token punctuation">{</span>2c4de342-38b7-51cf-b940-2309a097f518<span class="token punctuation">}</span><br><span class="token assign-left variable">WSL_INTEROP</span><span class="token operator">=</span>/run/WSL/8_interop<br><span class="token assign-left variable">NAME</span><span class="token operator">=</span>beet<br><span class="token assign-left variable"><span class="token environment constant">HOME</span></span><span class="token operator">=</span>/home/beet<br><span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span>beet<br><span class="token assign-left variable"><span class="token environment constant">LOGNAME</span></span><span class="token operator">=</span>beet<br><span class="token assign-left variable"><span class="token environment constant">SHELL</span></span><span class="token operator">=</span>/usr/bin/zsh<br><span class="token assign-left variable">WSL_DISTRO_NAME</span><span class="token operator">=</span>Ubuntu<br><span class="token assign-left variable"><span class="token environment constant">SHLVL</span></span><span class="token operator">=</span><span class="token number">2</span><br><span class="token assign-left variable"><span class="token environment constant">PWD</span></span><span class="token operator">=</span>/home/beet<br><span class="token assign-left variable"><span class="token environment constant">OLDPWD</span></span><span class="token operator">=</span>/home/beet<br><span class="token assign-left variable">PROMPT_EOL_MARK</span><span class="token operator">=</span><br><span class="token assign-left variable">CONDA_CHANGEPS1</span><span class="token operator">=</span>no<br><span class="token assign-left variable">VIRTUAL_ENV_DISABLE_PROMPT</span><span class="token operator">=</span><span class="token number">12</span><br><span class="token assign-left variable">_</span><span class="token operator">=</span>/usr/bin/env<br><span class="token comment">#####下面两个是agent的环境变量####</span><br><span class="token assign-left variable"><span class="token environment constant">SSH_AUTH_SOCK</span></span><span class="token operator">=</span>/tmp/ssh-nrFOHntUqfKi/agent.210<br><span class="token assign-left variable">SSH_AGENT_PID</span><span class="token operator">=</span><span class="token number">211</span></code></pre>
<blockquote>
<p>除了使用 <code>ssh-agent &lt;youShell&gt;</code> 和 <code> source &lt;(ssh-agent)</code> 可以替代 eval 外，还可以使用 <code>ssh-agent &lt;normal command&gt;</code> 使得 <code>&lt;normal command&gt;</code> 的进程处于 <code>ssh-agent</code> 的环境中，因此，上面两条命令实际可以使用一条命令代替：</p>
</blockquote>
<pre class="language-bash"><code class="language-bash">ssh-agent ssh-add</code></pre>
<h4>b.sshd (ssh daemon)</h4>
<p><code>sshd</code> 是 ssh 的守护进程，是通过 ssh 服务端连接必要条件。一般不需要我们手动管理，学会通过配置文件修改一些默认配置即可:</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 修改默认配置文件</span><br><span class="token function">vim</span> /etc/ssh/sshd_config<br><br><span class="token comment"># 几个常用的配置关键字 </span><br><span class="token comment">## ssd服务监听端口</span><br>Port <span class="token number">22</span><br><span class="token comment">## 禁止使用密码登录</span><br>PasswordAuthentication no<br><span class="token comment">## 允许作为root登录</span><br>PermitRootLogin <span class="token function">yes</span><br><span class="token comment">## 公钥保存位置</span><br>AuthorizedKeysFile      .ssh/authorized_keys<br><span class="token comment">## 允许agent转发</span><br>AllowAgentForwarding <span class="token function">yes</span><br><span class="token comment">## subsystem使用sftp-server</span><br>Subsystem       <span class="token function">sftp</span>    /usr/libexec/openssh/sftp-server</code></pre>
<h4>c.sftp-server</h4>
<p>sftp 的服务端子系统，可以于 <code>/etc/ssh/sshd_config</code> 修改。sftp-server 的存在是为了保存向后兼容，现在可以用sshd内置的 <code>internal-sftp</code> ，获取更好的性能。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 更改subsystem为internal-sftp</span><br>Subsystem <span class="token function">sftp</span> internal-sftp</code></pre>
<hr>
<blockquote>
<p>本文中用于的文件系统很少提及(我只功利性的关注了几个配置文件)，但其它的文件却非常重要，Manual中有详细的提示，还需坚持学习</p>
</blockquote>
<h3>ssh alias</h3>
<p>对于我来说，shell 设置太多 alias 感觉很乱，想要简化 ssh 的连接操作，可以使用 <code>ssh alias</code> 。</p>
<p>编辑 ssh 配置文件</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">vim</span> ~/.ssh/config</code></pre>
<p>按如下类似格式添加（不要修改原本内容）：</p>
<p>按如下类似格式写入：</p>
<pre class="language-bash"><code class="language-bash">Host hostaliasname<br>     HostName <span class="token number">221.236</span>.11.90<br>     User root<br>     Port <span class="token number">2233</span></code></pre>
<p>以后的连接就可以直接使用 <code>ssh &lt;hostaliasname&gt;</code>即可</p>
<h3>Openssh之外</h3>
<p>除了 Openssh 的强大工具，我还想介绍一个利用 sftp 挂载磁盘的工具，很是实用。</p>
<p><code>SSHFS</code> 可以通过 sftp 来挂载远端硬盘位置到本地：</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># mount </span><br>sshfs <span class="token punctuation">[</span>user@<span class="token punctuation">]</span><span class="token number">221.236</span>.11.90:<span class="token punctuation">[</span>directory<span class="token punctuation">]</span> mountpoint<br><span class="token comment"># unmount</span><br>fusermount -u mountpoint</code></pre>
<ul>
<li>
<p>参考及补充</p>
<p><a href="https://www.openssh.com/">openssh manual</a></p>
<p><a href="https://www.ssh.com/ssh/keygen/">ssh keygen</a></p>
<p><a href="https://serverfault.com/questions/660160/openssh-difference-between-internal-sftp-and-sftp-server">OpenSSH: Difference between internal-sftp and sftp-server</a></p>
<p><a href="https://stackoverflow.com/questions/34906302/add-public-key-to-known-hosts-file">add public key to known hosts file</a></p>
</li>
</ul>

	    </div>
	    <div class="outline"></div>
	</article>

     
		</main>
		<footer class="footer">
				    <div class="footer-desc" style="font-size:14px">
			made with love&<a style="color: skyblue;" href="https://www.11ty.dev/"
			    target="_blank">11ty</a> by beet
		    </div>
		</footer>

	    </body></html>